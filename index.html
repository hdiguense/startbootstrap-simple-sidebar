<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Costa Rica Coffee Mills</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/simple-sidebar.css" rel="stylesheet">

  <style>
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>
  <!-- JQUERY -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

</head>

<body>

  <div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="bg-light border-right" id="sidebar-wrapper">
      <!-- <div class="sidebar-heading">Filters </div> -->
      <div class="list-group list-group-flush">
        <form id="form_regions" class="list-group-item  bg-light">
          <p>Coffee Regions</p>
          <div class="form-check">
            <input type="checkbox" name='regions' class="form-check-input esri-widget" id="allregions" value="'ALL'"
              checked>
            <label class="form-check-label" for="allregions">All regions</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class=" esri-widget" name="regions" class="form-check-input" id="brunca"
              value="'Brunca'" checked>
            <label class="form-check-label" for="brunca">Brunca</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class=" esri-widget" name="regions" class="form-check-input" id="central_valley"
              value="'Valle Central'" checked>
            <label class="form-check-label" for="central_valley">Central Valley</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class=" esri-widget" name="regions" class="form-check-input" id="guanacaste"
              value="'Guanacaste'" checked>
            <label class="form-check-label" for="guanacaste">Guanacaste</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class=" esri-widget" name="regions" class="form-check-input" id="orosi"
              value="'Orosi'" checked>
            <label class="form-check-label" for="orosi">Orosí</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class=" esri-widget" name="regions" class="form-check-input" id="tarrazu"
              value="'Tarrazú'" checked>
            <label class="form-check-label" for="tarrazu">Tarrazú</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class=" esri-widget" name="regions" class="form-check-input" id="3rios"
              value="'Tres Ríos'" checked>
            <label class="form-check-label" for="3rios">Tres Ríos</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class=" esri-widget" name="regions" class="form-check-input" id="turrialba"
              value="'Turrialba'" checked>
            <label class="form-check-label" for="turrialba">Turrialba</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class=" esri-widget" name="regions" class="form-check-input" id="west_valley"
              value="'Valle Occidental'" checked>
            <label class="form-check-label" for="west_valley">West Valley</label>
          </div>
          <!-- <button type="submit" class="btn btn-primary">Submit</button> -->
        </form>
        <form id="form_process" class="list-group-item  bg-light">
          <p>Coffee processes</p>
          <div class="form-check">
            <input type="checkbox" name="process" class="form-check-input" id="allprocesses" value="procesos LIKE 'ALL'"
              checked>
            <label class="form-check-label" for="allprocesses">All processes</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="esri-widget" name="process" class="form-check-input" id="lavado"
              value="procesos LIKE '%Lavado%'" checked>
            <label class="form-check-label" for="lavado">Lavado</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="esri-widget" name="process" class="form-check-input" id="honey"
              value="procesos LIKE '%Honey%'" checked>
            <label class="form-check-label" for="honey">Honey</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="esri-widget" name="process" class="form-check-input" id="anaerobic"
              value="procesos LIKE '%Anaeróbico%'" checked>
            <label class="form-check-label" for="anaerobic">Anaerobic</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="esri-widget" name="process" class="form-check-input" id="natual"
              value="procesos LIKE '%Natural%'" checked>
            <label class="form-check-label" for="natural">Natural</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="esri-widget" name="process" class="form-check-input" id="other"
              value="procesos LIKE '%Otro%'" checked>
            <label class="form-check-label" for="other">Other</label>
          </div>
          <!-- <button type="submit" class="btn btn-primary">Submit</button> -->
        </form>
        <form id="form_mill" class="list-group-item  bg-light">
          <p>Mill size (fanegas)</p>
          <div class="form-check">
            <input type="checkbox" name="millsize" class="form-check-input" id="allsizes" value="(produccion > 0)"
              checked>
            <label class="form-check-label" for="allsizes">All sizes</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="esri-widget" name="millsize" class="form-check-input" id="size1"
              value="(produccion BETWEEN 0 AND 1000)" checked>
            <label class="form-check-label" for="size1">0 - 1000</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="esri-widget" name="millsize" class="form-check-input" id="size2"
              value="(produccion BETWEEN 1001 AND 6000)" checked>
            <label class="form-check-label" for="size2">1000 - 6000</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="esri-widget" name="millsize" class="form-check-input" id="size3"
              value="(produccion BETWEEN 6001 AND 30000)" checked>
            <label class="form-check-label" for="size3">6000 - 30000</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="esri-widget" name="millsize" class="form-check-input"
              value="(produccion BETWEEN 30001 AND 70000)" id="size4" checked>
            <label class="form-check-label" for="size4">30000 - 70000</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="esri-widget" name="millsize" class="form-check-input" id="size5"
              value="(produccion > 70000)" checked>
            <label class="form-check-label" for="size5">70000 - More</label>
          </div>
          <!-- <button type="submit" onclick="get_region(); return false" class="btn btn-primary">Submit</button> -->
        </form>
      </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">

      <!-- <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom" style="height: 6%;">
        <button class="btn btn-primary" id="menu-toggle">Menu</button>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
            <li class="nav-item active">
              <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Link</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Dropdown
              </a>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="#">Action</a>
                <a class="dropdown-item" href="#">Another action</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#">Something else here</a>
              </div>
            </li>
          </ul>
        </div>
      </nav> -->

      <div class="container-fluid" style="height: 100%;">
        <div id="toggle">
          <button class="btn btn-primary" id="menu-toggle">Filters</button>
          <!-- <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button> -->
        </div>
        <div id="viewDiv">
        </div>
      </div>
    </div>
    <!-- /#page-content-wrapper -->

  </div>
  <!-- /#wrapper -->

  <!-- Bootstrap core JavaScript -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Menu Toggle Script -->
  <script>
    $("#menu-toggle").click(function (e) {
      e.preventDefault();
      $("#wrapper").toggleClass("toggled");
    });
  </script>

</body>
<script>
  //select all for all regions
  $("#allregions").click(function () {
    $("input[name=regions]").prop("checked", $(this).prop("checked"));
  });

  $("input[name=regions]").click(function () {
    if (!$(this).prop("checked")) {
      $("#allregions").prop("checked", false);
    }
  });

  //select all for all processes
  $("#allprocesses").click(function () {
    $("input[name=process]").prop("checked", $(this).prop("checked"));
  });

  $("input[name=process]").click(function () {
    if (!$(this).prop("checked")) {
      $("#allprocesses").prop("checked", false);
    }
  });

  //select all for all processes
  $("#allsizes").click(function () {
    $("input[name=millsize]").prop("checked", $(this).prop("checked"));
  });

  $("input[name=millsize]").click(function () {
    if (!$(this).prop("checked")) {
      $("#allsizes").prop("checked", false);
    }
  });
</script>
<!-- ArcGIS JS-->
<link rel="stylesheet" href="https://js.arcgis.com/4.16/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.16/"></script>

<script>
  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/Basemap",
    // "esri/layers/VectorTileLayer", //remember add to function if needed
    "esri/widgets/BasemapToggle"
  ], function (Map, MapView, FeatureLayer, Basemap, BasemapToggle) {

    // var basemap = new Basemap({
    //   baseLayers: [
    //     new VectorTileLayer({
    //       portalItem: {
    //         id: "7675d44bb1e4428aa2c30a9b68f97822" // Mid-Century
    //       }
    //     })
    //   ]
    // });
    
    var map = new Map({
      basemap: "gray"
    });

    var view = new MapView({
      container: "viewDiv",
      map: map,
      center: [-84, 10],
      zoom: 8,
      ui: {
        components: []
      }
    });

    var promotional_regions = new FeatureLayer({
      url: "https://sig.icafe.cr/server/rest/services/Hosted/Regiones_cafetaleras_de_promoci%C3%B3n/FeatureServer/",
      outFields: ["*"],
      popupTemplate: {
        title: '<div style="font-family: Avenir_Heavy"><b>{Region}</b></div>',
        content: '<video width="100%" controls autoplay><source src="https://sig.icafe.cr/coffeemills/videos/{video}" type="video/mp4">d</video>'
      }
    });

    map.add(promotional_regions, 0);

    function createFillSymbol(value, link) {
      return {
        value: value,
        symbol: {
          type: "picture-marker",
          url: link,
          width: "30px",
          height: "40px"
        },
        label: value
      };
    };

    var renderer = {
      type: "unique-value",
      field: "REGION_PROMOCIONAL",
      uniqueValueInfos: [
        createFillSymbol("Brunca", "https://sig.icafe.cr/coffeemills/icons/brunca.svg"),
        createFillSymbol("Valle Central", "https://sig.icafe.cr/coffeemills/icons/CENTRAL VALLEY.svg"),
        createFillSymbol("Guanacaste", "https://sig.icafe.cr/coffeemills/icons/GUANCASTE.svg"),
        createFillSymbol("Orosí", "https://sig.icafe.cr/coffeemills/icons/OROSI.svg"),
        createFillSymbol("Tarrazú", "https://sig.icafe.cr/coffeemills/icons/TARRAZU.svg"),
        createFillSymbol("Tres Ríos", "https://sig.icafe.cr/coffeemills/icons/TRES RIOS.svg"),
        createFillSymbol("Turrialba", "https://sig.icafe.cr/coffeemills/icons/TURRIALBA.svg"),
        createFillSymbol("Valle Occidental", "https://sig.icafe.cr/coffeemills/icons/WEST VALLEY.svg")
      ]
    };

    var featureLayer = new FeatureLayer({
      url: "https://sig.icafe.cr/server/rest/services/Hosted/Beneficios_CRCAFE/FeatureServer/",
      outFields: ["*"], // Return all fields so it can be queried client-side
      renderer: renderer,
      popupTemplate: {  // Enable a popup
        title: '<div style="font-family: Avenir_Heavy"><b>{RAZON_SOCIAL}</b></div>', // Show attribute value
        content: '<div style="font-family: AvenirBook"><a href="mailto:{contacto}">{contacto}</a></br></div><div style="font-family: AvenirBook"><img src={URL} alt="view" style="width:40%;"> {HISTORIA}</div>',  // Display in pop-up
      }
    });

    //regions
    var regions = document.getElementsByName('regions');
    var regions_sql = 'REGION_PROMOCIONAL IN (';
    var regions_values = '';

    //processes
    var processes = document.getElementsByName('process');
    var processes_values = '';

    //millsize
    var millzise = document.getElementsByName('millsize');
    var millsize_sql = '';

    function get_region() {

      //regions
      regions_sql = 'REGION_PROMOCIONAL IN (';
      regions_values = '';
      for (i = 0; i < regions.length; i++) {

        if (regions[i].checked === true) {
          regions_values += regions[i].value + ', ';
        };
      };

      //Processes
      processes_values = '';
      for (i = 0; i < processes.length; i++) {
        if (processes[i].checked === true) {
          processes_values += processes[i].value + ' OR ';
        };
      };

      //MillSize
      millsize_sql = ''
      for (i = 0; i < millzise.length; i++) {
        if (millzise[i].checked === true) {
          millsize_sql += millzise[i].value + ' OR ';
        };

      };

      //update view
      var expression = regions_sql + regions_values.substring(0, regions_values.length - 2) + ") AND (" + processes_values + "procesos LIKE 'dummy') AND (" + millsize_sql + " produccion = 99999999999999999)";
      view.whenLayerView(featureLayer).then(function (featureLayerView) {
        featureLayerView.filter = {
          where: expression
        };
      });
      console.log(expression)
    };

    //regions event listener
    for (i = 0; i < regions.length; ++i) {
      regions[i].addEventListener('change', get_region);
      // console.log(regions[i])
    };

    //processes event listener
    for (i = 0; i < processes.length; ++i) {
      processes[i].addEventListener('change', get_region);
      // console.log(processes[i])
    };

    //size event listener
    for (i = 0; i < millzise.length; ++i) {
      millzise[i].addEventListener('change', get_region);
      // console.log(millzise[i])
    };

    
    map.add(featureLayer);

    var basemapToggle = new BasemapToggle({
      view: view,
      nextBasemap: "hybrid"
    });

    view.ui.add(basemapToggle, "top-right");

    view.ui.add("toggle", "top-left");

  });
</script>

</html>